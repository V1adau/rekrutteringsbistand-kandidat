@Library('deploy')
import deploy
deployLib = new deploy()

githubAppId = '23179'
githubAppCredentialId = 'teampam-ci'
def newApiToken() {
    withEnv(['HTTPS_PROXY=webproxy-internett.nav.no:8088']) {
        withCredentials([file(credentialsId: githubAppCredentialId, variable: 'KEYFILE')]) {
            dir('token') {
                def generatedToken = sh(script: "generate-jwt.sh \$KEYFILE ${githubAppId} | xargs generate-installation-token.sh", returnStdout: true)
                return generatedToken.trim()
            }
        }
    }
}

node {
    def githubAppToken = newApiToken();
    def app = "pam-kandidatsok"

	stage("Initialization") {
        cleanWs()
		withEnv(['HTTPS_PROXY=http://webproxy-utvikler.nav.no:8088']) {
			println("Repository URL is https://x-access-token:****@github.com/navikt/${app}.git")
            sh(script: "set +x; git clone https://x-access-token:${githubAppToken}@github.com/navikt/${app}.git .")
		}
    }

    def qaDir = "${env.WORKSPACE}/qa"
    def qaFolder = new File(qaDir)

    if (qaFolder.exists()) {
		withEnv(['HTTPS_PROXY=http://webproxy-internett.nav.no:8088', 'HTTP_PROXY=http://webproxy-internett.nav.no:8088', 'NO_PROXY=localhost,127.0.0.1,maven.adeo.no,oera.no', 'NODE_TLS_REJECT_UNAUTHORIZED=0', 'PORT=8081']) {
			sh "cd ${qaDir} && npm i -D"
		}
		sauce('sauceconnect') {
			sauceconnect(options: "--proxy webproxy-internett.nav.no:8088 --proxy-tunnel --tunnel-identifier jenkins-${app} --se-port 4445", useLatestSauceConnect: true) {
				stage("Testing Chrome, Firefox, Edge, IE and Safari on Windows and MacOS") {
					acceptanceTests(qaDir)
				}
			}
		}
	}
}

def acceptanceTests(qaDir) {
	try {
		sh "cd ${qaDir} && npm run-script sauce-jenkins-all -- --skiptags ignore"
	} catch (Exception e) {
		throw new Exception("Cucumber/Nightwatch-tester feilet, se Cucumber Report for detaljer", e)
	} finally {
	    sh "cd ${qaDir} && npm run-script cucumber-report "
    	publishHTML([allowMissing: false, alwaysLinkToLastBuild: true, keepAll: false, reportDir: 'qa/reports', reportFiles: 'cucumber_report.html', reportName: "Cucumber Report"])
	}
}
